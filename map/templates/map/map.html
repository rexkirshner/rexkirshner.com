{% extends 'base.html' %}

{% block css %}
    <link href="/static/map/map.css" rel="stylesheet">
{% endblock %}


{% block javascript %}
    
    <script src='https://maps.googleapis.com/maps/api/js?key=AIzaSyBN4BYI6eqF2WlQE2HVbHkSP_Ldu6USWZw&sensor=true'></script>
    <script type="text/javascript">
        var map;
        var path;
        var total_locations = [];
        function initialize() {
            var mapOptions = {
                center: new google.maps.LatLng(39.8282, -98.5795),
                zoom: 4,
                scrollwheel: false,
            };
            map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);

        }
        
        
        google.maps.event.addDomListener(window, 'load', initialize);
        
        function pullMap() {
            
            total_locations = [];
            $.getJSON('api/location_history/', function(data){
                $.each(data, function(i, obj) {
                    obj['timestamp'] = Number(obj['timestamp']);
                    total_locations.push(obj);
                });
                var end = new Date(total_locations[0]['timestamp']);
                $( "#end_date" ).val( (end.getMonth() + 1) + '/' + end.getDate() + '/' + end.getFullYear());
                var start = new Date(total_locations[total_locations.length-1]['timestamp']);
                $( "#start_date" ).val( (start.getMonth() + 1) + '/' + start.getDate() + '/' + start.getFullYear()); 
                updateMap();
            });
            
            
            
        }
        
        function updateMap(){
            path.setMap(null);
            
            var start = Number(new Date($('#start_date').val()).getTime());
            var end = Number(new Date($('#end_date').val()).getTime());
            var layovers = $('#layovers').is(':checked');
            
            
            var f;
            for (f = 0; f < total_locations.length; f++) 
                if (end >= total_locations[f]['timestamp']) break;

            var s;
            for (s = total_locations.length - 1; s >= 0; s--) 
                if (start <= total_locations[s]['timestamp']) break; 
            
            var locations = []
            for (var i = f; i <= s; i++) {
                if (!layovers)
                    if (total_locations[i]['layover']) 
                        continue;
                    
                locations.push(new google.maps.LatLng(total_locations[i]['lat'], total_locations[i]['long']));
            }
                        
            path = new google.maps.Polyline({
                    path: locations,
                    geodesic: true,
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 2
                });
            path.setMap(map);
            $( "#loading-area" ).isLoading( "hide" );
        }
        
        
        $(function() {
            path = new google.maps.Polyline();
            $( "#start_date" ).datepicker();
            $( "#end_date" ).datepicker();
            $( "#start_date" ).change(function () {updateMap()});
            $( "#end_date" ).change(function () {updateMap()});
            $( "#layovers" ).change(function () {updateMap()});

            pullMap();
        
            $( "#loading-area" ).isLoading({
                position: "overlay"
            });    

        });
        
        
            
            
        
        
        
        
        
        
        
        
        
    </script>
{% endblock %}


{% block content %}
    <div id="map" class="panel panel-default map-panel">
        <div id='loading-area'>
            <div class="panel-header">
                <div id='map-controls'>
                    <form  id='map-form' class="form-inline" role="form">
                    <div class='center'>
                      <div class="form-group">
                      <label>
                        <input type="text" class="form-control" id="start_date" >
                      </label>
                      </div>
                      <div class="form-group">
                        <label>
                        <input type="text" class="form-control" id="end_date">
                        </label>
                      </div>
                        <label>
                          <input type="checkbox" id='layovers' checked> Show Layovers
                        </label>
                    </div>
                    </form>
                </div>
            </div>
        
        
            <div class="panel-body" id="map-canvas">
                Panel content
            </div>
        </div>
      
    </div>
{% endblock %}